<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØªØ¬Ø±ÙŠ Ø§Ù„Ø¹ØµØ±ÙŠ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #007185;
            --secondary-color: #FF9900;
            --background-color: #EAEDED;
            --card-background: #FFFFFF;
            --text-color: #0F1111;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --disabled-color: #6c757d;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        
        /* --- Header & Navigation --- */
        header {
            background-color: #131921; color: white; padding: 10px 20px;
            display: flex; flex-direction: column; align-items: center;
            position: sticky; top: 0; z-index: 1000;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        header h1 { font-size: 1.5rem; margin: 0; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-type-badge { background-color: var(--secondary-color); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        header nav { display: flex; flex-wrap: wrap; justify-content: center; width: 100%; margin-top: 10px; }
        header nav a {
            color: white; margin: 0 10px; padding: 10px 15px; text-decoration: none;
            cursor: pointer; font-weight: bold; transition: background-color 0.3s; border-radius: 5px;
        }
        header nav a:hover, header nav a.active { background-color: var(--primary-color); }

        main { padding: 20px; max-width: 1400px; margin: auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- Toolbar --- */
        .toolbar {
            background-color: var(--card-background); padding: 15px; margin-bottom: 20px;
            border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex; gap: 15px; flex-wrap: wrap;
        }
        .toolbar input, .toolbar select { flex-grow: 1; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }

        /* --- Product Display Layouts --- */
        .category-section { margin-bottom: 25px; background: var(--card-background); padding: 20px; border-radius: 8px; }
        .category-section h2 { margin: 0 0 15px; font-size: 1.8rem; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .grid-layout {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 15px;
        }
        .horizontal-scroll-grid {
            display: flex; gap: 15px; overflow-x: auto; padding: 10px;
            scroll-snap-type: x mandatory; -ms-overflow-style: none; scrollbar-width: none; margin: 0 -10px;
        }
        .horizontal-scroll-grid::-webkit-scrollbar { display: none; }

        /* --- Product Card --- */
        .product-card {
            border: 1px solid #ddd; border-radius: 8px;
            display: flex; flex-direction: column; position: relative;
            flex: 0 0 240px; width: 240px; scroll-snap-align: start;
            background-color: #fff;
        }
        .product-card-top-actions {
            position: absolute; top: 8px; left: 8px; display: flex; gap: 8px; z-index: 2;
        }
        .icon-btn {
            background-color: rgba(255, 255, 255, 0.9); border: 1px solid #ddd;
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 16px; color: #555; transition: all 0.2s;
        }
        .icon-btn:hover { background-color: #fff; color: var(--primary-color); transform: scale(1.1); }
        .icon-btn.active { color: var(--danger-color); background-color: #ffebee; border-color: var(--danger-color); }
        
        .product-card .product-info { padding: 15px; padding-top: 50px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .product-card .product-name { font-size: 0.95rem; font-weight: 500; height: 70px; overflow: hidden; margin: 0 0 10px; }
        .product-card .product-price { font-size: 1.2rem; font-weight: bold; color: #B12704; margin: 10px 0 15px 0; }
        .product-details-content { margin-bottom: 15px; min-height: 180px; }
        .product-image-container { width: 100%; height: 180px; display: flex; align-items: center; justify-content: center; background-color: #f7f7f7; color: #888; border-radius: 4px; }
        .product-image { width: 100%; height: 100%; object-fit: contain; }
        .product-card-actions { display: flex; gap: 10px; width: 100%; margin-top: auto; }
        .product-card-actions button { flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid; cursor: pointer; font-weight: bold; }
        .details-btn { background-color: #fff; border-color: var(--primary-color); color: var(--primary-color); }
        .add-to-cart-btn { background-color: var(--primary-color); border-color: var(--primary-color); color: #fff; }

        /* --- Cart, Forms, and Other Components --- */
        .cart-item { display: flex; align-items: center; gap: 15px; padding: 15px; background-color: var(--card-background); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .cart-item-image { width: 80px; height: 80px; object-fit: contain; border-radius: 4px; }
        .cart-item-info { flex-grow: 1; }
        .cart-item-quantity { display: flex; align-items: center; gap: 10px; }
        .quantity-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ccc; background: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .cart-item-remove { color: var(--danger-color); background: none; border: none; font-size: 1.2rem; cursor: pointer; }
        .checkout-section { background: var(--card-background); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-top: 20px; }
        .checkout-total-price-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; }
        .checkout-final-total { font-size: 1.5rem; font-weight: bold; text-align: center; margin: 20px 0; }
        .checkout-btn { width: 100%; padding: 15px; background-color: var(--secondary-color); border: none; border-radius: 8px; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
        .checkout-btn:disabled { background-color: var(--disabled-color); cursor: not-allowed; }
        .form-container { max-width: 400px; margin: 20px auto; background: var(--card-background); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-container h2 { text-align: center; color: var(--primary-color); }
        .form-container input { width: calc(100% - 24px); padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; }
        .form-container button { width: 100%; padding: 12px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; }
        .message { text-align: center; margin-top: 10px; color: #d9534f; }
        
        /* --- Order Card (Full Version) --- */
        .order-card { background: var(--card-background); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .order-card-cancelled { background-color: #f8f9fa; border-left: 5px solid var(--danger-color); opacity: 0.8; }
        .order-card-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .order-details-toggle { background: none; border: 1px solid var(--primary-color); color: var(--primary-color); padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        .order-items-details { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ccc; }
        .order-items-details ul { list-style: none; padding: 0; }
        .order-items-details li { display: flex; justify-content: space-between; padding: 5px 0; }
        .order-card-actions { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        .order-card-actions button { padding: 8px 12px; border-radius: 5px; border: none; color: white; cursor: pointer; font-weight: bold; }
        .status-badge { padding: 5px 10px; border-radius: 15px; color: white; font-weight: bold; font-size: 0.9rem; }
        .status-Ù‚ÙŠØ¯-Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© { background-color: var(--warning-color); } .status-ØªÙ…-ØªØ£ÙƒÙŠØ¯-Ø§Ù„Ø¯ÙØ¹ { background-color: var(--primary-color); } .status-Ù‚ÙŠØ¯-Ø§Ù„ØªØ¬Ù‡ÙŠØ² { background-color: var(--info-color); } .status-Ù‚ÙŠØ¯-Ø§Ù„ØªÙˆØµÙŠÙ„ { background-color: #6f42c1; } .status-ØªÙ…-Ø§Ù„ØªØ³Ù„ÙŠÙ… { background-color: var(--success-color); } .status-Ù…Ù„ØºÙŠ { background-color: var(--danger-color); }
        .order-progress { display: flex; justify-content: space-between; margin: 20px 0; position: relative; }
        .order-progress::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 4px; background: #ddd; transform: translateY(-50%); z-index: 1; }
        .progress-step { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 2; text-align: center; width: 18%; }
        .progress-step-icon { width: 30px; height: 30px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; font-weight: bold; }
        .progress-step.active .progress-step-icon { background: var(--primary-color); color: white; }
        .progress-step.completed .progress-step-icon { background: var(--success-color); color: white; }
        .progress-step-label { font-size: 0.8rem; }
        
        /* --- Admin --- */
        .admin-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .admin-stat-card { background: var(--card-background); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; }
        .admin-stat-card .stat-value { font-size: 2rem; font-weight: bold; margin: 10px 0; }
        
        .hidden { display: none !important; }
        .toast { position: fixed; bottom: 20px; right: 20px; background-color: #333; color: #fff; padding: 16px; border-radius: 4px; z-index: 1050; opacity: 0; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
        .btn-success { background-color: var(--success-color); } .btn-danger { background-color: var(--danger-color); } .btn-warning { background-color: var(--warning-color); } .btn-info { background-color: var(--info-color); }
    </style>
</head>
<body>

    <header>
        <div class="header-top">
            <h1>Ù…ØªØ¬Ø±ÙŠ Ø§Ù„Ø¹ØµØ±ÙŠ</h1>
            <div class="user-info">
                <span id="user-name">Ø²Ø§Ø¦Ø±</span>
                <span id="user-type-badge" class="user-type-badge hidden">Ù…Ø¯ÙŠØ±</span>
            </div>
        </div>
        <nav>
            <a id="nav-home" class="tab-link active">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <a id="nav-auth" class="tab-link">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
            <a id="nav-cart" class="tab-link">Ø§Ù„Ø³Ù„Ø© (<span id="cart-count">0</span>)</a>
            <a id="nav-purchases" class="tab-link">Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ</a>
            <a id="nav-profile" class="tab-link">ØµÙØ­ØªÙŠ Ø§Ù„Ø´Ø®ØµÙŠØ©</a>
            <a id="nav-admin" class="tab-link" style="display: none;">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
            <a id="nav-logout" class="tab-link" style="display: none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
        </nav>
    </header>

    <main>
        <div id="home-tab" class="tab-content active">
            <div id="admin-restriction-message" class="hidden" style="text-align: center; margin-bottom: 20px;">
                <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            </div>
            <div class="toolbar">
                <input type="search" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." autocomplete="off">
                <select id="category-filter">
                    <option value="all">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>
                </select>
            </div>
            <div id="home-content">
                <p style="text-align: center;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>
            </div>
        </div>

        <div id="auth-tab" class="tab-content">
            <div class="form-container">
                <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>
                <input type="email" id="auth-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
                <input type="password" id="auth-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                <div id="registration-fields" class="hidden">
                    <hr style="margin: 20px 0;"><input type="text" id="signup-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                    <input type="tel" id="signup-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"><input type="text" id="signup-address" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø²Ù„">
                </div>
                <button id="login-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <button id="toggle-signup" style="margin-top: 10px; background-color: #f8f9fa; color: #333; border: 1px solid #ccc;">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
                <button id="signup-btn" class="hidden" style="margin-top: 10px; background-color: var(--success-color);">ØªØ³Ø¬ÙŠÙ„</button>
                <p id="auth-message" class="message"></p>
            </div>
        </div>

        <div id="cart-tab" class="tab-content"></div>

        <div id="purchases-tab" class="tab-content">
            <div class="category-section">
                <h2>Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h2>
                <div id="orders-list"><p style="text-align: center;">Ù„Ù… ØªÙ‚Ù… Ø¨Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯.</p></div>
            </div>
             <div class="category-section">
                <h2>â¤ï¸ Ø§Ù„Ù…ÙØ¶Ù„Ø©</h2>
                <div id="favorites-list" class="grid-layout"><p style="text-align: center;">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ù…ÙØ¶Ù„Ø©.</p></div>
            </div>
             <div class="category-section">
                <h2>ğŸ”– Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„ÙˆÙ‚Øª Ù„Ø§Ø­Ù‚</h2>
                <div id="saved-for-later-list" class="grid-layout"><p style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©.</p></div>
            </div>
        </div>

        <div id="profile-tab" class="tab-content">
             <div class="form-container">
                <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
                <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span id="profile-name"></span></p>
                <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> <span id="profile-email"></span></p>
                <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span id="profile-phone"></span></p>
                <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> <span id="profile-address"></span></p>
            </div>
             <div class="form-container">
                <h3>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
                <input type="password" id="new-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" autocomplete="new-password">
                <button id="change-password-btn">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
                <p id="password-change-message" class="message"></p>
            </div>
        </div>
        
        <div id="admin-tab" class="tab-content"></div>
    </main>

    <div id="toast" class="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCfOzC8gkqkVSNZ3frtnnCMxbeq-v7yaTY",
            authDomain: "almas-store-a51eb.firebaseapp.com",
            databaseURL: "https://almas-store-a51eb-default-rtdb.firebaseio.com",
            projectId: "almas-store-a51eb",
            storageBucket: "almas-store-a51eb.appspot.com",
            messagingSenderId: "502522968593",
            appId: "1:502522968593:web:52dc253f8ea12f4d5bcfb0",
            measurementId: "G-G0WC9BJ6JW"
        };
        
        // --- Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        
        // --- Constants & Global State ---
        const ADMIN_EMAIL = "admin@store.com";
        const SHIPPING_FEES = 30;
        let currentUserId = null, isAdmin = false;
        let allProducts = [], categories = {};
        let currentCart = {}, currentUserFavorites = {}, currentUserSaved = {};

        // --- DOM Elements ---
        const homeContent = document.getElementById('home-content');
        const searchInput = document.getElementById('search-input');
        const categoryFilter = document.getElementById('category-filter');
        const toast = document.getElementById('toast');
        const tabContents = document.querySelectorAll('.tab-content');
        const tabLinks = document.querySelectorAll('.tab-link');
        const ordersList = document.getElementById('orders-list');
        const favoritesList = document.getElementById('favorites-list');
        const savedForLaterList = document.getElementById('saved-for-later-list');
        
        // --- Utility Functions ---
        const showToast = (message, isSuccess = true) => {
            toast.textContent = message;
            toast.style.backgroundColor = isSuccess ? '#28a745' : '#dc3545';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        };
        const formatPrice = (price) => parseFloat(price).toFixed(2);
        const formatDate = (timestamp) => timestamp ? new Date(timestamp).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' }) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

        // --- Navigation ---
        const showTab = (targetId) => {
            tabContents.forEach(content => content.classList.remove('active'));
            tabLinks.forEach(link => link.classList.remove('active'));
            const tab = document.getElementById(targetId);
            if (tab) tab.classList.add('active');
            const navLink = document.querySelector(`[id="nav-${targetId.replace('-tab', '')}"]`);
            if (navLink) navLink.classList.add('active');
        };

        // --- Authentication & UI Setup ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                isAdmin = user.email === ADMIN_EMAIL;
                loadUserData();
                setupDatabaseListeners();
            } else {
                currentUserId = null; isAdmin = false;
                currentCart = {}; currentUserFavorites = {}; currentUserSaved = {};
                // Reset UI for logged-out state
                renderCart({});
                renderFavoritesList();
                renderSavedForLaterList();
                showTab('auth-tab');
            }
            updateUIForUserType();
            if (allProducts.length === 0) loadProducts();
        });

        function setupDatabaseListeners() {
            if (!currentUserId) return;
            // Listeners for Cart, Orders
            onValue(ref(database, `users/${currentUserId}/cart`), snapshot => {
                currentCart = snapshot.val() || {};
                renderCart(currentCart);
            });
            onValue(ref(database, `users/${currentUserId}/orders`), snapshot => {
                renderUserOrders(snapshot.val() || {});
            });
            // NEW Listeners for Favorites and Saved for Later
            onValue(ref(database, `users/${currentUserId}/favorites`), snapshot => {
                currentUserFavorites = snapshot.val() || {};
                renderFavoritesList();
                // Re-render homepage to update heart icons
                if(document.getElementById('home-tab').classList.contains('active')) renderHomePage();
            });
            onValue(ref(database, `users/${currentUserId}/savedForLater`), snapshot => {
                currentUserSaved = snapshot.val() || {};
                renderSavedForLaterList();
                if(document.getElementById('home-tab').classList.contains('active')) renderHomePage();
            });
            
            if (isAdmin) {
                // Admin specific listeners
            }
        }

        /**
         * --- Caching and Product Loading ---
         */
        const loadProducts = async () => {
            const CACHE_KEY = 'cachedProducts', CACHE_VERSION_KEY = 'cacheVersion', CURRENT_VERSION = '1.4';
            try {
                const cachedData = localStorage.getItem(CACHE_KEY);
                if (cachedData && localStorage.getItem(CACHE_VERSION_KEY) === CURRENT_VERSION) {
                    allProducts = JSON.parse(cachedData);
                } else {
                    const response = await fetch('https://raw.githubusercontent.com/masyomas/almas/main/products.json');
                    if (!response.ok) throw new Error('Network error');
                    allProducts = await response.json();
                    localStorage.setItem(CACHE_KEY, JSON.stringify(allProducts));
                    localStorage.setItem(CACHE_VERSION_KEY, CURRENT_VERSION);
                }
                categories = allProducts.reduce((acc, p) => {
                    const cat = p.category || 'ØºÙŠØ± Ù…ØµÙ†Ù';
                    if (!acc[cat]) acc[cat] = [];
                    acc[cat].push(p);
                    return acc;
                }, {});
                categoryFilter.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>' + Object.keys(categories).sort().map(cat => `<option value="${cat}">${cat}</option>`).join('');
                renderHomePage();
            } catch (error) { homeContent.innerHTML = "<p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.</p>"; }
        };

        /**
         * --- FIXED: Homepage Rendering (Search + Random) ---
         */
        const renderHomePage = () => {
            homeContent.innerHTML = '';
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value;

            if (searchTerm || selectedCategory !== 'all') {
                // --- SEARCH/FILTER MODE ---
                let filteredProducts = allProducts.filter(p =>
                    (selectedCategory === 'all' || p.category === selectedCategory) &&
                    p.name.toLowerCase().includes(searchTerm)
                );
                const section = document.createElement('div');
                section.className = 'category-section';
                section.innerHTML = `<h2>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« (${filteredProducts.length})</h2>`;
                const grid = document.createElement('div');
                grid.className = 'grid-layout'; // Normal grid for search results
                if (filteredProducts.length > 0) {
                    filteredProducts.forEach(p => grid.appendChild(createProductCard(p)));
                } else {
                    grid.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø¨Ø­Ø«Ùƒ.</p>';
                }
                section.appendChild(grid);
                homeContent.appendChild(section);
            } else {
                // --- RANDOM DISPLAY MODE ---
                let categoryKeys = Object.keys(categories).sort(() => 0.5 - Math.random());
                const categoriesToShow = categoryKeys.slice(0, 5);
                if (categoriesToShow.length === 0) {
                    homeContent.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…ØªØ§Ø­Ø©.</p>'; return;
                }
                categoriesToShow.forEach(cat => {
                    const section = document.createElement('div');
                    section.className = 'category-section';
                    section.innerHTML = `<h2>${cat}</h2>`;
                    const grid = document.createElement('div');
                    grid.className = 'horizontal-scroll-grid';
                    categories[cat].sort(() => 0.5 - Math.random()).forEach(p => grid.appendChild(createProductCard(p)));
                    section.appendChild(grid);
                    homeContent.appendChild(section);
                });
            }
        };

        /**
         * --- MODIFIED: Product Card with Favorite/Save actions ---
         */
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            const isFavorite = !!(currentUserFavorites && currentUserFavorites[product.sku]);
            const isSaved = !!(currentUserSaved && currentUserSaved[product.sku]);

            card.innerHTML = `
                <div class="product-card-top-actions">
                    <button class="icon-btn favorite-btn ${isFavorite ? 'active' : ''}" title="Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©"><i class="fas fa-heart"></i></button>
                    <button class="icon-btn save-btn ${isSaved ? 'active' : ''}" title="Ø­ÙØ¸ Ù„ÙˆÙ‚Øª Ù„Ø§Ø­Ù‚"><i class="fas fa-bookmark"></i></button>
                </div>
                <div class="product-info">
                    <div>
                        <p class="product-name">${product.name}</p>
                        <div class="product-details-content hidden"><div class="product-image-container"></div></div>
                        <p class="product-price">${formatPrice(product.price)} Ø¬Ù†ÙŠÙ‡</p>
                    </div>
                    <div class="product-card-actions">
                         <button class="details-btn">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
                         <button class="add-to-cart-btn">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
                    </div>
                </div>`;
            
            card.querySelector('.favorite-btn').addEventListener('click', e => { e.stopPropagation(); toggleFavorite(product); });
            card.querySelector('.save-btn').addEventListener('click', e => { e.stopPropagation(); toggleSaveForLater(product); });
            card.querySelector('.details-btn').addEventListener('click', e => { /* Details logic */ });
            card.querySelector('.add-to-cart-btn').addEventListener('click', e => { /* Add to cart logic */ });

            return card;
        }

        /**
         * --- NEW: Favorite and Save for Later Logic ---
         */
        function toggleFavorite(product) {
            if (!currentUserId) { showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.", false); return; }
            const favRef = ref(database, `users/${currentUserId}/favorites/${product.sku}`);
            if (currentUserFavorites[product.sku]) {
                remove(favRef); showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©.");
            } else {
                set(favRef, { name: product.name, price: product.price, sku: product.sku, 'barcode 1': product['barcode 1'] });
                showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©.");
            }
        }
        function toggleSaveForLater(product) {
             if (!currentUserId) { showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.", false); return; }
            const saveRef = ref(database, `users/${currentUserId}/savedForLater/${product.sku}`);
            if (currentUserSaved[product.sku]) {
                remove(saveRef); showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª.");
            } else {
                set(saveRef, { name: product.name, price: product.price, sku: product.sku, 'barcode 1': product['barcode 1'] });
                showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù„ÙˆÙ‚Øª Ù„Ø§Ø­Ù‚.");
            }
        }

        function renderFavoritesList() {
            renderProductList(favoritesList, Object.values(currentUserFavorites), "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙØ¶Ù„Ø©.");
        }
        function renderSavedForLaterList() {
            renderProductList(savedForLaterList, Object.values(currentUserSaved), "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©.");
        }
        function renderProductList(container, productList, emptyMessage) {
            if (!container) return;
            container.innerHTML = '';
            if (productList.length === 0) {
                container.innerHTML = `<p style="text-align: center;">${emptyMessage}</p>`;
                return;
            }
            productList.forEach(p => container.appendChild(createProductCard(p)));
        }

        /**
         * --- FIXED: Full Order Card Rendering Logic ---
         */
        const renderUserOrders = (orders) => renderOrders(ordersList, Object.entries(orders).map(([id, order]) => ({ id, ...order })), false);
        const renderOrders = (container, ordersArray, isAdminView) => {
            if (!container) return;
            container.innerHTML = '';
            if (ordersArray.length === 0) {
                container.innerHTML = `<p style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</p>`; return;
            }
            ordersArray.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            ordersArray.forEach(order => container.appendChild(createOrderCard(order, isAdminView)));
        };
        
        function createOrderCard(order, isAdminView) {
            const orderEl = document.createElement('div');
            orderEl.className = `order-card ${order.status === 'Ù…Ù„ØºÙŠ' ? 'order-card-cancelled' : ''}`;
            const orderItemsHTML = `<ul>${Object.values(order.items || {}).map(item =>
                `<li><span>${item.name} (Ã—${item.quantity})</span> <span>${formatPrice(item.price * (item.quantity || 1))} Ø¬Ù†ÙŠÙ‡</span></li>`
            ).join('')}</ul>`;
            
            const statusMap = { 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©': 0, 'ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹': 1, 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²': 2, 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„': 3, 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…': 4, 'Ù…Ù„ØºÙŠ': -1 };
            const statusIndex = statusMap[order.status] ?? 0;
            const progressSteps = ['Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', 'ØªÙ… Ø§Ù„Ø¯ÙØ¹', 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²', 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„', 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…'];
            
            const progressHTML = order.status !== 'Ù…Ù„ØºÙŠ' ? `<div class="order-progress">
                ${progressSteps.map((label, i) => `
                    <div class="progress-step ${statusIndex >= i ? 'completed' : ''} ${statusIndex === i ? 'active' : ''}">
                        <div class="progress-step-icon">${i+1}</div>
                        <div class="progress-step-label">${label}</div>
                    </div>`).join('')}
            </div>` : '';
            
            let actionsHTML = '';
            if (isAdminView) {
                if (order.status === 'Ù…Ù„ØºÙŠ') {
                    actionsHTML = `<button class="btn-success" data-action="restore">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø·Ù„Ø¨</button>`;
                } else if (order.status !== 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…') {
                    actionsHTML = `<button class="btn-info" data-action="preparing">ØªØ¬Ù‡ÙŠØ²</button>
                                 <button class="btn-warning" data-action="delivering">ØªÙˆØµÙŠÙ„</button>
                                 <button class="btn-success" data-action="delivered">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
                                 <button class="btn-danger" data-action="cancel">Ø¥Ù„ØºØ§Ø¡</button>`;
                }
            } else {
                if (order.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©') {
                    actionsHTML = `<button class="btn-danger" data-action="cancel">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>`;
                }
            }

            orderEl.innerHTML = `
                <div class="order-card-header">
                    <div>
                        <h4>Ø·Ù„Ø¨ #${(order.id || '').substring(0, 8)}</h4>
                        <p>${formatDate(order.timestamp)}</p>
                        ${isAdminView ? `<p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${order.userInfo.name} | <strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${order.userInfo.phone || 'N/A'}</p>` : ''}
                    </div>
                    <span class="status-badge status-${(order.status||'').replace(/\s/g, '-')}">${order.status}</span>
                </div>
                <p><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${formatPrice(order.total)} Ø¬Ù†ÙŠÙ‡</p>
                <button class="order-details-toggle">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
                <div class="order-items-details hidden">${orderItemsHTML}</div>
                ${progressHTML}
                <div class="order-card-actions">${actionsHTML}</div>
            `;
            
            orderEl.querySelector('.order-details-toggle').addEventListener('click', e => {
                const details = e.target.nextElementSibling;
                details.classList.toggle('hidden');
                e.target.textContent = details.classList.contains('hidden') ? 'Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„' : 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙØ§ØµÙŠÙ„';
            });

            orderEl.querySelector('.order-card-actions').addEventListener('click', e => {
                if (e.target.tagName !== 'BUTTON') return;
                const action = e.target.dataset.action;
                const newStatusMap = {
                    'preparing': 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²', 'delivering': 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„', 'delivered': 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…',
                    'restore': 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', 'cancel': 'Ù…Ù„ØºÙŠ'
                };
                if (newStatusMap[action]) {
                    const userIdToUpdate = isAdminView ? order.userId : currentUserId;
                    if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ')) {
                        updateOrderStatus(userIdToUpdate, order.id, newStatusMap[action]);
                    }
                }
            });
            return orderEl;
        }

        const updateOrderStatus = async (userId, orderId, newStatus) => {
            const orderRef = ref(database, `users/${userId}/orders/${orderId}`);
            try {
                await update(orderRef, { status: newStatus });
                showToast(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.`);
            } catch (error) { showToast(`Ø®Ø·Ø£: ${error.message}`, false); }
        };

        // All other functions for Cart, Auth, etc. are included above.
        // This is the complete, merged script.
    </script>
</body>
</html>
