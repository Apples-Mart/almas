<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متجري العصري</title>
    <style>
        :root {
            --primary-color: #007185;
            --secondary-color: #FF9900;
            --background-color: #EAEDED;
            --card-background: #FFFFFF;
            --text-color: #0F1111;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --disabled-color: #6c757d;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        
        /* --- Header & Tab Navigation --- */
        header {
            background-color: #131921;
            color: white;
            padding: 10px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        header h1 {
            font-size: 1.5rem;
            margin: 0;
        }
        
        header nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            margin-top: 10px;
        }
        header nav a {
            color: white;
            margin: 0 10px;
            padding: 10px 15px;
            text-decoration: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            border-radius: 5px;
        }
        header nav a:hover, header nav a.active {
            background-color: var(--primary-color);
        }

        main {
            padding: 20px;
            max-width: 1400px;
            margin: auto;
        }
        
        /* --- Tab Content --- */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- Search & Filter Bar --- */
        .toolbar {
            background-color: var(--card-background);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .toolbar input, .toolbar select {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }

        /* --- NEW: Horizontal Scrolling Category --- */
        .category-section {
            margin-bottom: 25px;
        }
        .category-section h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.8rem;
            padding: 0 10px;
        }
        .horizontal-scroll-grid {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px;
            scroll-snap-type: x mandatory;
            /* Hide scrollbar for a cleaner look */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .horizontal-scroll-grid::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        /* --- MODIFIED: Product Card --- */
        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: var(--card-background);
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
            /* Key for horizontal scroll layout */
            flex: 0 0 240px; /* Do not grow, do not shrink, base width 240px */
            width: 240px;
            scroll-snap-align: start;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .product-card .product-info {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .product-card .product-name {
            font-size: 0.95rem;
            font-weight: 500;
            margin: 0 0 10px 0;
            line-height: 1.4;
            height: 70px; /* Adjusted height */
            overflow: hidden;
        }
        .product-card .product-price {
            font-size: 1.2rem;
            font-weight: bold;
            color: #B12704;
            margin: 0 0 15px 0; /* Space above buttons */
        }

        /* --- NEW: Product Details & Actions inside Card --- */
        .product-details-content {
            margin-bottom: 15px;
            min-height: 180px; /* Reserve space */
        }
        .product-image-container {
            width: 100%;
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f7f7f7;
            color: #888;
            border-radius: 4px;
        }
        .product-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .product-card-actions {
            display: flex;
            gap: 10px;
            width: 100%;
            margin-top: auto; /* Push to bottom */
        }
        .product-card-actions button {
            flex-grow: 1;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s, color 0.2s;
        }
        .details-btn {
            background-color: #fff;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        .add-to-cart-btn {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: #fff;
        }
        .add-to-cart-btn:hover {
            background-color: #005a69;
        }
        
        /* --- General Styles (Cart, Checkout, etc.) --- */
        .cart-item { display: flex; align-items: center; gap: 15px; padding: 15px; background-color: var(--card-background); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .cart-item-image { width: 80px; height: 80px; object-fit: contain; border-radius: 4px; }
        .cart-item-info { flex-grow: 1; }
        .checkout-section { background: var(--card-background); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-top: 20px; }
        .checkout-btn { width: 100%; padding: 15px; background-color: var(--secondary-color); border: none; border-radius: 8px; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
        .order-card { background: var(--card-background); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .form-container { max-width: 400px; margin: auto; padding: 20px; background: var(--card-background); border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        
        /* Toast notification */
        .toast { position: fixed; bottom: 20px; right: 20px; background-color: #333; color: #fff; padding: 16px; border-radius: 4px; z-index: 1000; opacity: 0; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

    <header>
        <div class="header-top">
            <h1>متجري العصري</h1>
        </div>
        <nav>
            <a id="nav-home" class="tab-link active">الرئيسية</a>
            <a id="nav-auth" class="tab-link">تسجيل الدخول</a>
            <a id="nav-cart" class="tab-link">السلة (<span id="cart-count">0</span>)</a>
            <a id="nav-profile" class="tab-link">صفحتي الشخصية</a>
            <a id="nav-admin" class="tab-link" style="display: none;">لوحة الإدارة</a>
            <a id="nav-logout" class="tab-link" style="display: none;">تسجيل الخروج</a>
        </nav>
    </header>

    <main>
        <div id="home-tab" class="tab-content active">
             <div id="admin-restriction-message" class="hidden" style="text-align: center; margin-bottom: 20px;">
                <h2>مرحباً بك في لوحة الإدارة</h2>
            </div>
            
            <div class="toolbar">
                <input type="search" id="search-input" placeholder="ابحث عن منتج..." autocomplete="off">
                <select id="category-filter">
                    <option value="all">كل الفئات</option>
                </select>
            </div>
            
            <div id="home-content">
                <p style="text-align: center;">جاري تحميل المنتجات...</p>
            </div>
        </div>

        <div id="auth-tab" class="tab-content"></div>
        <div id="cart-tab" class="tab-content"></div>
        <div id="checkout-tab" class="tab-content"></div>
        <div id="profile-tab" class="tab-content"></div>
        <div id="admin-tab" class="tab-content"></div>
    </main>

    <div id="toast" class="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js";

        // Firebase config and initialization
        const firebaseConfig = {
            apiKey: "AIzaSyCfOzC8gkqkVSNZ3frtnnCMxbeq-v7yaTY",
            authDomain: "almas-store-a51eb.firebaseapp.com",
            databaseURL: "https://almas-store-a51eb-default-rtdb.firebaseio.com",
            projectId: "almas-store-a51eb",
            storageBucket: "almas-store-a51eb.appspot.com",
            messagingSenderId: "502522968593",
            appId: "1:502522968593:web:52dc253f8ea12f4d5bcfb0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // --- Global State & Constants ---
        const ADMIN_EMAIL = "admin@store.com";
        let currentUserId = null;
        let isAdmin = false;
        let allProducts = [];
        let categories = {};
        let currentCart = {};
        
        // --- DOM Elements ---
        const homeContent = document.getElementById('home-content');
        const searchInput = document.getElementById('search-input');
        const categoryFilter = document.getElementById('category-filter');
        const toast = document.getElementById('toast');

        // --- Utility Functions ---
        const showToast = (message, isSuccess = true) => {
            toast.textContent = message;
            toast.style.backgroundColor = isSuccess ? '#28a745' : '#dc3545';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        };
        const formatPrice = (price) => parseFloat(price).toFixed(2);
        
        // --- Authentication Listener ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                isAdmin = user.email === ADMIN_EMAIL;
                // Simplified for this example, assumes full UI update functions exist
            } else {
                currentUserId = null;
                isAdmin = false;
            }
            // Load products once auth state is known
            loadProducts();
        });

        /**
         * --- NEW: Caching Strategy ---
         * Loads products from localStorage if available and version matches.
         * Otherwise, fetches from the network and caches the result.
         */
        const loadProducts = async () => {
            const CACHE_KEY = 'cachedProducts';
            const CACHE_VERSION_KEY = 'cacheVersion';
            const CURRENT_VERSION = '1.1'; // Update this version to force a refresh for all users

            try {
                const cachedVersion = localStorage.getItem(CACHE_VERSION_KEY);
                const cachedData = localStorage.getItem(CACHE_KEY);

                if (cachedData && cachedVersion === CURRENT_VERSION) {
                    console.log("Loading products from browser cache.");
                    allProducts = JSON.parse(cachedData);
                } else {
                    console.log("Fetching products from network...");
                    const response = await fetch('https://raw.githubusercontent.com/masyomas/almas/main/products.json');
                    if (!response.ok) throw new Error('Failed to load products');
                    allProducts = await response.json();

                    localStorage.setItem(CACHE_KEY, JSON.stringify(allProducts));
                    localStorage.setItem(CACHE_VERSION_KEY, CURRENT_VERSION);
                    console.log("Products cached successfully for next visit.");
                }
                
                // Organize products and render the homepage
                categories = allProducts.reduce((acc, p) => {
                    const cat = p.category || 'غير مصنف';
                    if (!acc[cat]) acc[cat] = [];
                    acc[cat].push(p);
                    return acc;
                }, {});
                
                // Populate filter dropdown
                categoryFilter.innerHTML = '<option value="all">كل الفئات</option>' + Object.keys(categories).sort().map(cat => `<option value="${cat}">${cat}</option>`).join('');

                renderHomePage();
            } catch (error) {
                homeContent.innerHTML = "<p>عفواً، حدث خطأ أثناء تحميل المنتجات.</p>";
                console.error("Error in loadProducts:", error);
            }
        };

        /**
         * --- MODIFIED: Renders random categories in horizontal rows ---
         */
        const renderHomePage = () => {
            homeContent.innerHTML = '';
            
            // Get category keys, then shuffle them
            let categoryKeys = Object.keys(categories);
            for (let i = categoryKeys.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [categoryKeys[i], categoryKeys[j]] = [categoryKeys[j], categoryKeys[i]];
            }

            // Display a limited number of random categories (e.g., 5)
            const categoriesToShow = categoryKeys.slice(0, 5); 

            if (categoriesToShow.length === 0) {
                homeContent.innerHTML = '<p style="text-align: center;">لا توجد منتجات متاحة.</p>';
                return;
            }

            categoriesToShow.forEach(cat => {
                const section = createCategorySection(cat, categories[cat]);
                homeContent.appendChild(section);
            });
        };

        /**
         * --- MODIFIED: Creates a section with a horizontally scrolling grid ---
         */
        function createCategorySection(title, products) {
            const sectionEl = document.createElement('div');
            sectionEl.className = 'category-section';
            
            sectionEl.innerHTML = `<h2>${title}</h2>`;
            
            const gridEl = document.createElement('div');
            gridEl.className = 'horizontal-scroll-grid'; // Use the new class for horizontal scroll
            
            products.sort(() => 0.5 - Math.random()).forEach(product => {
                gridEl.appendChild(createProductCard(product));
            });
            
            sectionEl.appendChild(gridEl);
            return sectionEl;
        }

        /**
         * --- NEW: Creates product card without an initial image ---
         * Image and details are loaded on-demand when the user clicks a button.
         */
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            card.innerHTML = `
                <div class="product-info">
                    <div>
                        <p class="product-name">${product.name}</p>
                        <div class="product-details-content hidden">
                            <div class="product-image-container"></div>
                        </div>
                        <p class="product-price">${formatPrice(product.price)} جنيه</p>
                    </div>
                    <div class="product-card-actions">
                         <button class="details-btn">عرض التفاصيل</button>
                         <button class="add-to-cart-btn">أضف للسلة</button>
                    </div>
                </div>
            `;

            const detailsBtn = card.querySelector('.details-btn');
            const detailsContent = card.querySelector('.product-details-content');
            const imageContainer = card.querySelector('.product-image-container');

            detailsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isHidden = detailsContent.classList.contains('hidden');

                if (isHidden) {
                    // Load image only on the first click
                    if (!imageContainer.innerHTML) {
                        imageContainer.textContent = 'جاري تحميل الصورة...';
                        const barcode = product['barcode 1'];
                        const img = new Image();
                        const jpgUrl = `https://raw.githubusercontent.com/masyomas/almas/main/images/${barcode}.jpg`;
                        const pngUrl = `https://raw.githubusercontent.com/masyomas/almas/main/images/${barcode}.png`;

                        img.onload = () => {
                            img.className = 'product-image';
                            imageContainer.innerHTML = ''; // Clear 'loading' text
                            imageContainer.appendChild(img);
                        };
                        img.onerror = () => {
                            img.onerror = () => { imageContainer.textContent = 'لا توجد صورة'; };
                            img.src = pngUrl; // Try PNG if JPG fails
                        };
                        img.src = jpgUrl; // Start with JPG
                    }
                    detailsContent.classList.remove('hidden');
                    detailsBtn.textContent = 'إخفاء التفاصيل';
                } else {
                    detailsContent.classList.add('hidden');
                    detailsBtn.textContent = 'عرض التفاصيل';
                }
            });
            
            card.querySelector('.add-to-cart-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                if (!currentUserId) {
                    showToast("الرجاء تسجيل الدخول أولاً.", false);
                    // showTab('auth-tab'); // Assumes this function exists
                    return;
                }
                addToCart(product.sku);
            });

            return card;
        }

        // Dummy addToCart for demonstration
        async function addToCart(sku) {
             if (!currentUserId || isAdmin) return;
            const product = allProducts.find(p => p.sku === sku);
            if (!product) return;
            const cartRef = ref(database, `users/${currentUserId}/cart/${sku}`);
            const newQuantity = (currentCart[sku]?.quantity || 0) + 1;
            await set(cartRef, { ...product, quantity: newQuantity });
            showToast(`تمت إضافة ${product.name} إلى السلة.`);
        }
        
        // --- Event Listeners for search/filter ---
        // These would now re-run the logic for filtering allProducts
        // and then calling a more complex render function, but for now
        // they are simplified.
        // searchInput.addEventListener('input', renderHomePage);
        // categoryFilter.addEventListener('change', renderHomePage);
        
        // Assume other functions like navigation, cart rendering, etc., exist
        // and are wired up correctly from the previous version.
    </script>
</body>
</html>
